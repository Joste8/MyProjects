{# 1. Customer mumbu vaangiya items-inte names edukkuka #}
{% set purchasedItems = [] %}
{% for purchase in entity.instance.purchases %}
    {# Ningalude Purchase entity-il property 'itemName' ennaano 'name' ennaano ennu urappu varuthuka #}
    {% set purchasedItems = purchasedItems|merge([purchase.itemName]) %}
{% endfor %}

<div class="card border-primary mb-4 shadow-sm" style="border-left: 5px solid #007bff;">
    <div class="card-body">
        <h5 class="card-title text-primary"><i class="fas fa-lightbulb"></i> Next Purchase Suggestions</h5>
        <p class="text-muted small">Based on your history, you might also like these:</p>
        
        <div class="d-flex flex-wrap gap-2">
            {% set suggested = false %}
            
            {# 2. Controller-il ninnu pass cheytha allProducts loop cheyyunnu #}
            {% for product in field.customOptions.get('allProducts')|default([]) %}
                
                {# 3. Alredy vaangiya product alla ennu urappu varuthunnu #}
                {% if product.name not in purchasedItems %}
                    {% set suggested = true %}
                    <div class="p-2 border rounded bg-light mr-2 mb-2 shadow-sm">
                        <strong class="text-dark">{{ product.name }}</strong>
                        <div class="text-info small">Recommended for you</div>
                    </div>
                {% endif %}

            {% endfor %} {# <--- Loop ivide aanu close cheyyendath #}

            {% if not suggested %}
                <p class="text-muted italic small">No new suggestions available at the moment.</p>
            {% endif %}
        </div>
    </div>
</div>